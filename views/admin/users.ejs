<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - School Management</title>
  <link rel="stylesheet" href="/css/style2.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.cdnfonts.com/css/manrope" rel="stylesheet">

  <style>
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 8px;
      background: #f9f9f9;
    }

    .filters .filter-box {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filters input[type="text"], .filters select {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }

    .filters label {
      font-weight: 600;
    }

    .table-container table {
      width: 100%;
      border-collapse: collapse;
    }

    .text-center {
      text-align: center;
    }

    @media (max-width: 768px) {
      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .filters .filter-box {
        width: 100%;
        justify-content: space-between;
      }

      .filters input[type="text"], .filters select {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <%- include('../partials/sidebar') %>

  <!-- Main Content -->
  <div class="main-content">
    <header>
      <button class="menu-btn" id="menuBtn">
        <i class="fa fa-bars"></i>
      </button>
      <h1>User Management</h1>
    </header>

    <!-- Page content -->
    <main class="admin-content">
      <!-- Filters -->
      <section class="filters card">
        <div class="filter-box">
          <label for="searchInput">Search:</label>
          <input type="text" id="searchInput" placeholder="Search by name or email...">
        </div>

        <div class="filter-box">
          <label for="filter-role">Role:</label>
          <select id="filter-role" onchange="filterUsers()">
            <option value="all">All Roles</option>
            <option value="student">Student</option>
            <option value="parent">Parent</option>
            <option value="teacher">Teacher</option>
          </select>
        </div>

        <div class="filter-box">
          <label for="filter-status">Status:</label>
          <select id="filter-status" onchange="filterUsers()">
            <option value="all">All Status</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
          </select>
        </div>

        <div class="filter-box">
          <label for="sort-select">Sort By:</label>
          <select id="sort-select" onchange="filterUsers()">
            <option value="">Default</option>
            <option value="name-asc">Name (A–Z)</option>
            <option value="name-desc">Name (Z–A)</option>
            <option value="role-asc">Role (A–Z)</option>
            <option value="role-desc">Role (Z–A)</option>
            <option value="date-asc">Joined (Oldest)</option>
            <option value="date-desc">Joined (Newest)</option>
          </select>
        </div>
      </section>

      <!-- Users Table -->
      <section class="table-container">
        <table id="users-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Role</th>
              <th>Student</th>
              <th>Status</th>
              <th>Joined</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% if (users.length === 0) { %>
              <tr>
                <td colspan="7" class="text-center">No users found</td>
              </tr>
            <% } else { %>
              <% users.forEach(user => { %>
                <tr 
                  data-role="<%= user.role %>" 
                  data-status="<%= user.isActive %>"
                  data-name="<%= user.name.toLowerCase() %>"
                  data-email="<%= user.email.toLowerCase() %>"
                  data-date="<%= new Date(user.createdAt).getTime() %>"
                >
                  <td><%= user.name %></td>
                  <td><%= user.email %></td>
                  <td>
                    <span class="badge badge-<%= user.role %>">
                      <%= user.role.charAt(0).toUpperCase() + user.role.slice(1) %>
                    </span>
                  </td>
                  <td>
                    <% if (user.student) { %>
                      <%= user.student.name %> (<%= user.student.regNumber %>)
                    <% } else { %>
                      N/A
                    <% } %>
                  </td>
                  <td>
                    <span class="badge badge-<%= user.isActive ? 'success' : 'danger' %>">
                      <%= user.isActive ? 'Active' : 'Inactive' %>
                    </span>
                  </td>
                  <td><%= new Date(user.createdAt).toLocaleDateString() %></td>
                  <td class="actions">
                    <% if (user.isActive) { %>
                      <form action="/api/users/<%= user._id %>/deactivate" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-warning">
                          <i class="fa fa-ban"></i> Deactivate
                        </button>
                      </form>
                    <% } else { %>
                      <form action="/api/users/<%= user._id %>/activate" method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-success">
                          <i class="fa fa-check"></i> Activate
                        </button>
                      </form>
                    <% } %>
                  </td>
                </tr>
              <% }); %>
            <% } %>
          </tbody>
        </table>
      </section>
    </main>
  </div>

<script>
  let originalRows = [];

  window.addEventListener("DOMContentLoaded", () => {
    // Store all rows when page first loads
    const rows = document.querySelectorAll("#users-table tbody tr");
    originalRows = Array.from(rows);
  });

  function filterUsers() {
    const roleFilter = document.getElementById("filter-role").value;
    const statusFilter = document.getElementById("filter-status").value;
    const searchText = document.getElementById("searchInput").value.toLowerCase();
    const sortValue = document.getElementById("sort-select").value;

    // Start filtering from the original dataset
    let filtered = [...originalRows].filter((row) => {
      const rowRole = row.dataset.role;
      const rowStatus = row.dataset.status;
      const name = row.dataset.name;
      const email = row.dataset.email;

      const roleMatch = roleFilter === "all" || rowRole === roleFilter;
      const statusMatch = statusFilter === "all" || rowStatus === statusFilter;
      const searchMatch = name.includes(searchText) || email.includes(searchText);

      return roleMatch && statusMatch && searchMatch;
    });

    // Sorting logic
    filtered.sort((a, b) => {
      const nameA = a.dataset.name;
      const nameB = b.dataset.name;
      const roleA = a.dataset.role;
      const roleB = b.dataset.role;
      const dateA = parseInt(a.dataset.date);
      const dateB = parseInt(b.dataset.date);

      switch (sortValue) {
        case "name-asc":
          return nameA.localeCompare(nameB);
        case "name-desc":
          return nameB.localeCompare(nameA);
        case "role-asc":
          return roleA.localeCompare(roleB);
        case "role-desc":
          return roleB.localeCompare(roleA);
        case "date-asc":
          return dateA - dateB;
        case "date-desc":
          return dateB - dateA;
        default:
          return 0;
      }
    });

    // Re-render the table body
    const tbody = document.querySelector("#users-table tbody");
    tbody.innerHTML = "";
    filtered.forEach((row) => tbody.appendChild(row));
  }

  // Trigger filtering whenever search input changes
  document.getElementById("searchInput").addEventListener("input", filterUsers);

  // Sidebar toggle for mobile
  const menuBtn = document.getElementById("menuBtn");
  const sidebar = document.getElementById("sidebar");
  menuBtn.addEventListener("click", () => {
    sidebar.classList.toggle("active");
  });
</script>
